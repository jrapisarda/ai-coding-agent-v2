{% extends "base.html" %}
{% block title %}{{ project.name }} Â· Task Management System{% endblock %}
{% block content %}
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">{{ project.name }}</h1>
      <p class="text-muted mb-2">{{ project.description|default:"No description provided." }}</p>
      <div class="progress" role="progressbar" aria-valuenow="{{ project.completion_percentage }}" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar" style="width: {{ project.completion_percentage }}%;">
          {{ project.completion_percentage }}%
        </div>
      </div>
      <p class="small text-muted mt-1 mb-0">{{ project.completed_tasks }} of {{ project.total_tasks }} tasks complete</p>
      {% if project.overdue_tasks > 0 %}
        <p class="small text-danger mt-2 mb-0">{{ project.overdue_tasks }} task{{ project.overdue_tasks|pluralize }} overdue</p>
      {% endif %}
    </div>
    <div class="d-flex flex-column flex-md-row gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'projects:export-project' project.slug 'csv' %}">Export CSV</a>
      <a class="btn btn-outline-secondary" href="{% url 'projects:export-project' project.slug 'json' %}">Export JSON</a>
      {% if not project.archived %}
        <form method="post" action="{% url 'projects:archive-project' project.slug %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">Archive</button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="row g-3">
        {% for value, label in status_labels %}
          <div class="col-md-4">
            <div class="kanban-column h-100">
              <div class="kanban-column__header">
                <h2 class="h6 mb-0">{{ label }}</h2>
                <span class="badge text-bg-secondary">{{ task_columns[value]|length|default:0 }}</span>
              </div>
              <div class="kanban-column__body">
                {% for task in task_columns[value] %}
                  <div class="kanban-card">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h3 class="h6 mb-1">{{ task.title }}</h3>
                        <p class="small text-muted mb-1">Priority: {{ task.get_priority_display }}</p>
                      </div>
                      <span class="badge text-bg-light text-uppercase">{{ task.get_status_display }}</span>
                    </div>
                    {% if task.description %}
                      <p class="small mb-2">{{ task.description }}</p>
                    {% endif %}
                    <ul class="list-unstyled small mb-2">
                      {% if task.assignee %}<li><strong>Assignee:</strong> {{ task.assignee }}</li>{% endif %}
                      {% if task.due_date %}
                        <li>
                          <strong>Due:</strong>
                          <span class="{% if task.is_overdue %}text-danger{% endif %}">{{ task.due_date|date:"M j, Y" }}</span>
                        </li>
                      {% endif %}
                      {% if task.comment %}<li><strong>Comment:</strong> {{ task.comment }}</li>{% endif %}
                    </ul>
                    <div class="d-flex gap-2">
                      <a class="btn btn-sm btn-outline-secondary" href="{% url 'projects:update-task' task.pk %}">Edit</a>
                      <form method="post" action="{% url 'projects:update-task-status' task.pk %}">
                        {% csrf_token %}
                        <div class="input-group input-group-sm">
                          <select name="status" class="form-select form-select-sm">
                            {% for option_value, option_label in status_labels %}
                              <option value="{{ option_value }}" {% if task.status == option_value %}selected{% endif %}>{{ option_label }}</option>
                            {% endfor %}
                          </select>
                          <button class="btn btn-outline-primary" type="submit">Move</button>
                        </div>
                      </form>
                    </div>
                  </div>
                {% empty %}
                  <p class="small text-muted">No tasks yet.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">Add Task</h2>
          <form method="post" action="{% url 'projects:add-task' project.slug %}" novalidate>
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label" for="id_title">Title</label>
              {{ task_form.title }}
              {% if task_form.title.errors %}
                <div class="invalid-feedback d-block">{{ task_form.title.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label" for="id_description">Description</label>
              {{ task_form.description }}
              {% if task_form.description.errors %}
                <div class="invalid-feedback d-block">{{ task_form.description.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label" for="id_due_date">Due date</label>
              {{ task_form.due_date }}
              {% if task_form.due_date.errors %}
                <div class="invalid-feedback d-block">{{ task_form.due_date.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label class="form-label" for="id_priority">Priority</label>
              {{ task_form.priority }}
            </div>
            <div class="mb-3">
              <label class="form-label" for="id_assignee">Assignee</label>
              {{ task_form.assignee }}
            </div>
            <div class="mb-3">
              <label class="form-label" for="id_comment">Comment</label>
              {{ task_form.comment }}
            </div>
            <button type="submit" class="btn btn-primary w-100">Add task</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
